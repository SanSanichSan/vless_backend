#!/bin/bash

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
# –ü—Å–µ–≤–¥–æ–Ω–∏–º —Ö–æ—Å—Ç–∞ –∏–∑ –≤–∞—à–µ–≥–æ ~/.ssh/config
REMOTE_ALIAS=$1

# –ò–º—è –≤–∞—à–µ–≥–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞ —Å —Ñ–∞–π–ª–∞–º–∏
SOURCE_DIR="remnanode"

# –ö—É–¥–∞ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ø—Ä–æ–µ–∫—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å)
DEST_DIR="/opt/remnanode"
# -----------------

echo "üöÄ –ù–∞—á–∏–Ω–∞—é —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ —Ö–æ—Å—Ç '$REMOTE_ALIAS'..."

# –®–ê–ì 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
# --------------------------------------------------
# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø–æ SSH –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –æ–¥–Ω—É –∫–æ–º–∞–Ω–¥—É:
# 1. `sudo mkdir -p ${DEST_DIR}` - –°–æ–∑–¥–∞–µ—Ç —Ü–µ–ª–µ–≤–æ–π –∫–∞—Ç–∞–ª–æ–≥ (–∏ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ).
# 2. `&&` - –í—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â—É—é –∫–æ–º–∞–Ω–¥—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–µ—Ä–≤–∞—è —É—Å–ø–µ—à–Ω–∞.
# 3. `sudo chown \$USER:\$USER ${DEST_DIR}` - –î–µ–ª–∞–µ—Ç –≤–∞—Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º —ç—Ç–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞.
#    –≠—Ç–æ –ö–õ–Æ–ß–ï–í–û–ô –º–æ–º–µ–Ω—Ç, —á—Ç–æ–±—ã `scp` –º–æ–≥ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —Ñ–∞–π–ª—ã –±–µ–∑ `sudo`.
#    –û–±—Ä–∞—Ç–Ω—ã–π —Å–ª—ç—à `\` –ø–µ—Ä–µ–¥ `$USER` –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —Ä–∞—Å–∫—Ä—ã–ª–∞—Å—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –∞ –Ω–µ –ª–æ–∫–∞–ª—å–Ω–æ.
echo "‚Ä∫ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é –∫–∞—Ç–∞–ª–æ–≥ ${DEST_DIR} –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh ${REMOTE_ALIAS} "sudo mkdir -p ${DEST_DIR} && sudo chown \$USER:\$USER ${DEST_DIR}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–µ–¥—ã–¥—É—â–∞—è –∫–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–∏–ª–∞—Å—å –±–µ–∑ –æ—à–∏–±–æ–∫
if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–ª–∏ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –ü—Ä–µ—Ä—ã–≤–∞—é—Å—å."
    exit 1
fi


# –®–ê–ì 2: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
# --------------------------------------------------
# –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞ –≤ —Å–æ–∑–¥–∞–Ω–Ω—ã–π —É–¥–∞–ª–µ–Ω–Ω—ã–π.
# –¢–æ—á–∫–∞ –≤ –∫–æ–Ω—Ü–µ `SOURCE_DIR/.` –≤–∞–∂–Ω–∞ ‚Äî –æ–Ω–∞ –æ–∑–Ω–∞—á–∞–µ—Ç "–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ".
echo "‚Ä∫ –ö–æ–ø–∏—Ä—É—é —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞..."
scp -r ./${SOURCE_DIR}/. ${REMOTE_ALIAS}:${DEST_DIR}/

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã. –ü—Ä–µ—Ä—ã–≤–∞—é—Å—å."
    exit 1
fi


# –®–ê–ì 3: –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# --------------------------------------------------
# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è —Å–Ω–æ–≤–∞ –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞.
echo "‚Ä∫ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Docker –∏ –∑–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å—ã..."
ssh ${REMOTE_ALIAS} "
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
    if ! command -v docker &> /dev/null
    then
        echo 'Docker –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é...'
        curl -fsSL https://get.docker.com | sh
    fi

    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ–µ–∫—Ç–∞
    cd ${DEST_DIR}

    # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
    docker compose up -d

    echo '‚úÖ –ì–æ—Ç–æ–≤–æ! –£–∑–µ–ª vless —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω.'
"

echo "üéâ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ."
